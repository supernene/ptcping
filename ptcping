#!/usr/bin/env python3
# ptcping.py - Python TCP Ping Tool
# Author: Gemini AI (Modified by User)

import socket
import time
import sys
import signal
import argparse

rtt_list = []
sent_packets = 0
received_packets = 0

def handle_summary(signal_received, frame):
    """处理统计结果输出 (Ctrl+C 或程序结束时调用)"""
    print("\n--- TCP Ping 统计结果 ---")
    
    if sent_packets > 0:
        loss_rate = ((sent_packets - received_packets) / sent_packets) * 100
    else:
        loss_rate = 0.0

    print(f"发送: {sent_packets}, 接收: {received_packets}, 丢包率: {loss_rate:.2f}%")

    if rtt_list:
        min_rtt = min(rtt_list)
        max_rtt = max(rtt_list)
        avg_rtt = sum(rtt_list) / len(rtt_list)
        print(f"延迟 (ms) -> 最小: {min_rtt:.2f}, 最大: {max_rtt:.2f}, 平均: {avg_rtt:.2f}")
    else:
        print("没有成功的连接数据。")
    
    sys.exit(0)

# 捕获 Ctrl+C
signal.signal(signal.SIGINT, handle_summary)

def tcp_ping(host, port, count, timeout):
    global sent_packets, received_packets

    print(f"TCP Ping {host}:{port} ...")
    
    for i in range(count):
        sent_packets += 1
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        
        start_time = time.time()
        try:
            # 连接
            result = sock.connect_ex((host, port))
            end_time = time.time()
            
            if result == 0:
                duration_ms = (end_time - start_time) * 1000
                rtt_list.append(duration_ms)
                received_packets += 1
                print(f"来自 {host}:{port} 的回复: seq={i+1} 时间={duration_ms:.2f}ms")
            else:
                # connect_ex 返回非 0 错误码
                print(f"请求超时: seq={i+1} (Err: {result})")
        except socket.error as e:
            print(f"连接错误: seq={i+1} ({e})")
        finally:
            sock.close()
            
        if i < count - 1:
            time.sleep(1)

    handle_summary(None, None)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Python TCP Ping Tool")
    parser.add_argument("host", help="目标主机")
    parser.add_argument("port", type=int, help="目标端口")
    parser.add_argument("-c", "--count", type=int, default=10, help="发送次数 (默认: 10)")
    parser.add_argument("-t", "--timeout", type=float, default=2.0, help="超时时间 (默认: 2.0s)")

    args = parser.parse_args()
    
    tcp_ping(args.host, args.port, args.count, args.timeout)
